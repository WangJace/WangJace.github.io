I"W<p>æœ€è¿‘ç”¨swifté‡å†™ä¸€ä¸ªé¡¹ç›®ï¼Œé¡¹ç›®æ¶‰åŠäº†è“ç‰™çš„ç›¸å…³å¼€å‘ã€‚äºæ˜¯åšä¸€ä¸‹ç¬”è®°ï¼Œä»¥ä¾¿æ—¥åå†æ¬¡ç”¨åˆ°ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å’Œå¤§å®¶å…±äº«ã€‚</p>

<p><strong>1.å¯¼å…¥è“ç‰™åº“</strong>  <br />
å¦‚æœä½ åœ¨iOSå¼€å‘ä¸­ç›¸ä¸è“ç‰™è®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œå¿…é¡»å€’å…¥CoreBluetooth      <br />
{% highlight Objective-C %}
import CoreBluetooth
{% endhighlight %}
<strong>2.è®¾ç½®ä»£ç†</strong>  <br />
æ¥ä¸‹å»ï¼Œä½ å¯ä»¥ä»CBCentralManagerDelegateå’ŒCBPeripheralDelegateçš„å›è°ƒæ–¹æ³•è¿›è¡Œè“ç‰™é€šä¿¡çš„å®ç°
{% highlight Objective-C %}
class ViewController: UIViewController, CBCentralManagerDelegate, CBPeripheralDelegate {
  // More code
}
{% endhighlight %}
<strong>3.å£°æ˜managerå’Œperipheral</strong>  <br />
CBCentralManageræ˜¯ç”¨äºå‘ç°ã€è¿æ¥å’Œç®¡ç†è“ç‰™è®¾å¤‡çš„ã€‚ä¸€æ—¦ä½ è¿ä¸Šä¸€ä¸ªè“ç‰™è®¾å¤‡ï¼Œå‘ç°è“ç‰™è®¾å¤‡çš„serviceså’Œcharacteristicsï¼Œperipheralå°†å¸®åŠ©ä½ å¿«é€Ÿè·å–characteristicsã€è®¢é˜…characteristicsç­‰ã€‚
{% highlight Objective-C %}
var manager:CBCentralManager!<br />
var peripheral:CBPeripheral!
{% endhighlight %}
<strong>4.è·å–è“ç‰™è®¾å¤‡çš„UUIDå’ŒService</strong>  <br />
è“ç‰™è®¾å¤‡çš„æ‰€æœ‰serviceså’Œcharacteristicséƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„UUIDã€‚å¾ˆå¤šæ—¶å€™ä½ éƒ½éœ€è¦é€šè¿‡è¿™äº›UUIDæ¥è·å–ä½ æ‰€éœ€è¦çš„serviceså’Œcharacteristicsã€‚æ•´ä¸ªè“ç‰™é€šä¿¡çš„è¿‡ç¨‹ä¸­ä¼šåå¤ç”¨åˆ°è¿™äº›UUIDï¼Œæ‰€ä»¥æŠŠè¿™äº›ä¼šåå¤ç”¨åˆ°çš„UUIDå£°æ˜ä¸ºå…¨å±€çš„å¸¸é‡ä»¥ä¾¿äºå¤šä¸ªä»£ç†æ–¹æ³•é‡Œé¢å…±ç”¨ï¼Œæé«˜ä»£ç çš„æ•´æ´æ€§ã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹å®šçš„service/characteristicæ˜¯<a href="https://www.bluetooth.com/specifications/gatt/services">é€šç”¨</a>çš„ã€‚  <br />
{% highlight Objective-C %}
let BEAN_NAME = â€œRobuâ€<br />
let BEAN_SCRATCH_UUID = CBUUID(string: â€œa495ff21-c5b1-4b44-b512-1370f02d74deâ€)
let BEAN_SERVICE_UUID = CBUUID(string: â€œa495ff20-c5b1-4b44-b512-1370f02d74deâ€)
{% endhighlight %}
<strong>5.å®ä¾‹åŒ–CBCentralManager</strong>  <br />
ä½¿ç”¨ä¸€è¡Œä»£ç åˆ›å»ºä¸€ä¸ªCBCentralManagerå®ä¾‹ï¼Œæ‰€éœ€è¦çš„å‚æ•°æœ‰ä¸¤ä¸ªï¼Œmanagerçš„ä»£ç†å’Œå’Œè“ç‰™é€šä¿¡æ‰§è¡Œçš„çº¿ç¨‹ï¼ˆä¸€èˆ¬éƒ½ä¼ nilï¼Œè¡¨ç¤ºåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰ã€‚
{% highlight Objective-C %}
override func viewDidLoad() {<br />
  super.viewDidLoad()      <br />
  manager = CBCentralManager(delegate: self, queue: nil)
}
{% endhighlight %}
<strong>6.æ‰«æå¤–è®¾</strong>  <br />
ä¸€æ—¦å®ŒæˆCBCentralManagerçš„å®ä¾‹åŒ–ï¼Œä¼šå›è°ƒä»£ç†æ–¹æ³•centralManagerDidUpdateState(<em>:)ï¼Œæ›´æ–°å½“å‰çš„è“ç‰™çŠ¶æ€ï¼Œå¦‚æœè“ç‰™å·²å¼€å¯ï¼Œåˆ™å¯ä»¥å¼€å§‹æ‰«æå¤–è®¾ã€‚  <br />
{% highlight Objective-C %}
func centralManagerDidUpdateState(central: CBCentralManager) {<br />
  if central.state == CBCentralManagerState.PoweredOn {
    central.scanForPeripheralsWithServices(nil, options: nil)
  } else {
    print(â€œBluetooth not available.â€)
  }
}
{% endhighlight %}
<strong>7.è¿æ¥å¤–è®¾</strong>  <br />
æ¯æ¬¡æ‰«æåˆ°å¤–è®¾ï¼Œéƒ½ä¼šå›è°ƒä»£ç†æ–¹æ³•
centralManager(</em>:didDiscoverPeripheral:advertisementData:RSSI:)ï¼Œä½ å¯ä»¥åœ¨ä»£ç†æ–¹æ³•ä¸­è·å–å¤–è®¾çš„åç§°ï¼Œæ ¹æ®åç§°é€‰æ‹©ä½ è¦è¿æ¥çš„å¤–è®¾ã€‚
{% highlight Objective-C %}
func centralManager(central: CBCentralManager, didDiscoverPeripheral peripheral: CBPeripheral, advertisementData: [String : AnyObject], RSSI: NSNumber) {
  let device = (advertisementData as NSDictionary).objectForKey(CBAdvertisementDataLocalNameKey) as? NSString
  if device?.containsString(BEAN_NAME) == true {
    self.manager.stopScan()
    self.peripheral = peripheral
    self.peripheral.delegate = self
    manager.connectPeripheral(peripheral, options: nil)
  }
}
{% endhighlight %}
<strong>8.è·å–Services</strong>  <br />
ä¸€æ—¦ä½ æˆåŠŸè¿æ¥å¤–è®¾ï¼Œä½ å°±å¯ä»¥é€šè¿‡ä»£ç†æ–¹æ³•centralManager(<em>:didConnectPeripheral:)è·å–å¤–è®¾çš„æ‰€æœ‰Serviceã€‚
{% highlight Objective-C %}
func centralManager(central: CBCentralManager, didConnectPeripheral peripheral: CBPeripheral) {
  peripheral.discoverServices(nil) // nilè¡¨ç¤ºè·å–å¤–è®¾çš„æ‰€æœ‰æœåŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨UUIDæ¥åˆ›å»ºServiceï¼Œè·å–ç‰¹å®šçš„Service
}
{% endhighlight %}
<strong>9.è·å–Characteristics</strong>  <br />
å½“å‘ç°serviceæ—¶ï¼Œä¼šå›è°ƒä»£ç†æ–¹æ³•
peripheral(</em>:didDiscoverServices:)ï¼Œä½ å¯ä»¥åœ¨ä»£ç†æ–¹æ³•ä¸­è·å–ä½ æ‰€éœ€è¦çš„characteristics
{% highlight Objective-C %}
func peripheral(peripheral: CBPeripheral, didDiscoverServices error: NSError?) {
  for service in peripheral.services! {
    let thisService = service as CBService
    if service.UUID == BEAN_SERVICE_UUID {
      peripheral.discoverCharacteristics(nil, forService: thisService) // nilè¡¨ç¤ºè·å–æ‰€æœ‰çš„Characteristicï¼Œä¹Ÿå¯ä»¥é€šè¿‡UUIDè·å–ç‰¹å®šçš„Characteristic
    }
  }
}
{% endhighlight %}
<strong>10.è®¾ç½®é€šçŸ¥ç›‘å¬</strong>  <br />
å½“å‘ç°charecteristicæ—¶ä¼šå›è°ƒä»£ç†æ–¹æ³•
peripheral(<em>:didDiscoverCharacteristicsForService:error:)ã€‚æ­¤æ—¶ï¼Œè¯»å–å¤–è®¾æ•°æ®çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡characteristicä¸»åŠ¨è¯»å–æ•°æ®ï¼Œå¦å¤–ä¸€ç§æ—¶ç›‘å¬characteristicçš„æ•°æ®å˜åŒ–ã€‚
{% highlight Objective-C %}
func peripheral(peripheral: CBPeripheral, didDiscoverCharacteristicsForService service: CBService, error: NSError?) {
  for characteristic in service.characteristics! {
    let thisCharacteristic = characteristic as CBCharacteristic
    if thisCharacteristic.UUID == BEAN_SCRATCH_UUID {
      self.peripheral.setNotifyValue(true, forCharacteristic: thisCharacteristic
      )
    }
    else {
	self.peripheral.readValueForCharacteristic(thisCharacteristic)
    }
  }
}
{% endhighlight %}
<strong>11.æ•°æ®é€šä¿¡</strong>  <br />
å½“ä½ ç›‘å¬äº†æŸä¸ªcharacteristicï¼Œå½“è¿™ä¸ªcharacteristicå¯¹åº”çš„æ•°æ®å‘ç”Ÿå˜åŒ–ä¼šå›è°ƒä»£ç†æ–¹æ³•peripheral(</em>:didUpdateValueForCharacteristic:error:)ã€‚ä½ å¯ä»¥åœ¨è¿™ä¸ªä»£ç†æ–¹æ³•ä¸­å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚
{% highlight Objective-C %}
func peripheral(peripheral: CBPeripheral, didUpdateValueForCharacteristic characteristic: CBCharacteristic, error: NSError?) {
  var count:UInt32 = 0;
  if characteristic.UUID == BEAN_SCRATCH_UUID {
    characteristic.value!.getBytes(&amp;count, length: sizeof(UInt32))
    labelCount.text = NSString(format: â€œ%lluâ€, count) as String
  }
}
{% endhighlight %}
å½“ä½ æƒ³ä¼ é€’æ•°æ®ç»™å¤–è®¾æ—¶ï¼Œå¯ä»¥ä½¿ç”¨CBPeripheralçš„æ–¹æ³•writeValue(<em>:forCharacteristic:type:)æˆ–writeValue(</em>:forDescriptor:)æ¥ç»™å¤–è®¾å†™å…¥æ•°æ®ã€‚å½“å†™å…¥æˆåŠŸæ—¶ï¼Œä¼šå›è°ƒä»£ç†æ–¹æ³•peripheral(<em>:didWriteValueForCharacteristic:error:)æˆ–
peripheral(</em>:didWriteValueForDescriptor:error:)  <br />
<strong>12.æ–­å¼€è¿æ¥</strong>  <br />
å½“ä½ æƒ³æ–­å¼€è“ç‰™è¿æ¥æ—¶ï¼Œä½ å¯ä»¥æ‰§è¡ŒCBCentralManagerçš„æ–¹æ³•cancelPeripheralConnection(<em>:)ï¼Œè€Œå½“è“ç‰™è¿æ¥æ–­å¼€æ—¶ï¼Œä¼šå›è°ƒä»£ç†æ–¹æ³•centralManager(</em>:didDisconnectPeripheral:error:)ã€‚
{% highlight Objective-C %}
func centralManager(central: CBCentralManager, didDisconnectPeripheral peripheral: CBPeripheral, error: NSError?) {
  central.scanForPeripheralsWithServices(nil, options: nil)
}
{% endhighlight %}</p>

:ET